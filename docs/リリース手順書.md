# MopTabi リリース手順書

## 概要

本ドキュメントでは、MopTabiアプリケーションをCloudflareにデプロイするための手順を説明します。

- **Frontend**: Cloudflare Pages（Next.js）
- **Backend**: Cloudflare Workers（Hono）
- **Database**: PostgreSQL（Prisma Accelerate経由）

## 目次

1. [環境構成](#環境構成)
2. [事前準備](#事前準備)
3. [Backend デプロイ手順](#backend-デプロイ手順)
4. [Frontend デプロイ手順](#frontend-デプロイ手順)
5. [Staging環境での確認項目](#staging環境での確認項目)
6. [Productionリリース手順](#productionリリース手順)
7. [トラブルシューティング](#トラブルシューティング)

---

## 環境構成

| 環境 | ブランチ | Backend URL | Frontend URL |
|------|----------|-------------|--------------|
| Staging | `staging` | `https://staging.api-moptabi.workers.dev` | `https://staging.moptabi.pages.dev` |
| Production | `master` | `https://api-moptabi.workers.dev` | `https://moptabi.pages.dev` |

> **Note**: 上記URLは仮のものです。実際のURLはCloudflareダッシュボードで確認してください。

---

## 事前準備

### 1. stagingブランチの作成

```bash
# masterブランチから staging ブランチを作成
git checkout master
git pull origin master
git checkout -b staging
git push -u origin staging
```

### 2. 必要なアカウント・サービス

- [ ] Cloudflareアカウント（リポジトリ連携済み）
- [ ] Clerkアカウント（認証用）
- [ ] PostgreSQLデータベース（本番用）
- [ ] Prisma Accelerateアカウント（Edge環境でのDB接続用）

### 3. Prisma Accelerate の設定

Cloudflare Workersでは通常のPostgreSQL接続（TCP）がサポートされていないため、**Prisma Accelerate**を使用します。

1. [Prisma Data Platform](https://console.prisma.io/) にログイン
2. 新しいプロジェクトを作成
3. 「Accelerate」を有効化
4. データベース接続文字列を登録
5. 生成された `prisma://` 形式の接続URLを取得

```
# 例: Prisma Accelerate の接続URL
prisma://accelerate.prisma-data.net/?api_key=xxxxxxxx
```

---

## Backend デプロイ手順

### Step 1: wrangler.toml の作成

`backend/wrangler.toml` を作成：

```toml
name = "moptabi-api"
main = "src/index.ts"
compatibility_date = "2024-01-01"
compatibility_flags = ["nodejs_compat"]

# Staging環境の設定
[env.staging]
name = "moptabi-api-staging"
vars = { NODE_ENV = "staging" }

# Production環境の設定
[env.production]
name = "moptabi-api"
vars = { NODE_ENV = "production" }
```

### Step 2: Prisma スキーマの更新（Prisma 7対応）

`backend/prisma/schema.prisma` を更新：

```prisma
generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}
```

> **Note**: Prisma 7では`url`はスキーマファイルから削除されました。接続URLは`prisma.config.ts`で設定します。

### Step 2.1: Prisma Config の設定

`backend/prisma.config.ts`:

```typescript
import 'dotenv/config';
import path from 'node:path';
import { defineConfig } from 'prisma/config';

export default defineConfig({
  earlyAccess: true,
  schema: path.join(__dirname, 'prisma', 'schema.prisma'),
  migrate: {
    async url() {
      return process.env.DATABASE_URL ?? '';
    },
  },
});
```

### Step 2.2: PrismaClient の設定

**Docker/ローカル開発用** (`backend/src/lib/client.ts`):

```typescript
import { PrismaClient } from '@/generated/prisma';
import { PrismaPg } from '@prisma/adapter-pg';
import { Pool } from 'pg';

const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
});
const adapter = new PrismaPg(pool);

const createPrismaClient = () => {
  return new PrismaClient({
    adapter,
    log: process.env.NODE_ENV === 'development' ? ['query', 'error', 'warn'] : ['error'],
  });
};

export const prisma = createPrismaClient();
```

**Cloudflare Workers用** (Accelerate使用時):

```typescript
import { PrismaClient } from '@/generated/prisma';

const createPrismaClient = () => {
  return new PrismaClient({
    accelerateUrl: process.env.DATABASE_URL, // prisma:// URL
  });
};

export const prisma = createPrismaClient();
```

### Step 3: 環境変数の設定（Cloudflare Dashboard）

Cloudflare Dashboardで以下の環境変数を設定：

| 変数名 | 説明 | Staging | Production |
|--------|------|---------|------------|
| `DATABASE_URL` | Prisma Accelerate URL | `prisma://...` | `prisma://...` |
| `DIRECT_DATABASE_URL` | 直接DB接続URL（マイグレーション用） | PostgreSQL URL | PostgreSQL URL |
| `CLERK_PUBLISHABLE_KEY` | Clerk公開キー | Staging用 | Production用 |
| `CLERK_SECRET_KEY` | Clerkシークレットキー | Staging用 | Production用 |

> **重要**: Clerkでは環境ごとに異なるインスタンスを使用することを推奨します。

### Step 4: package.json にデプロイスクリプトを追加

```json
{
  "scripts": {
    "deploy:staging": "wrangler deploy --env staging",
    "deploy:production": "wrangler deploy --env production",
    "prisma:generate:edge": "prisma generate --no-engine"
  }
}
```

### Step 5: Staging デプロイ

```bash
cd backend

# Prismaクライアントを生成（Edge用）
bun run prisma:generate:edge

# Stagingにデプロイ
bun run deploy:staging
```

---

## Frontend デプロイ手順

### Step 1: @cloudflare/next-on-pages のインストール

```bash
cd frontend
npm install @cloudflare/next-on-pages
```

### Step 2: next.config.ts の更新

```typescript
import type { NextConfig } from 'next';

const nextConfig: NextConfig = {
  // Cloudflare Pages用の設定
  output: 'standalone',
  images: {
    // Cloudflare Imagesを使用する場合
    loader: 'custom',
    loaderFile: './src/lib/cloudflare-image-loader.ts',
    // または unoptimized を true に設定
    unoptimized: true,
  },
};

export default nextConfig;
```

### Step 3: 画像ローダーの作成（オプション）

`frontend/src/lib/cloudflare-image-loader.ts`:

```typescript
export default function cloudflareLoader({
  src,
  width,
  quality,
}: {
  src: string;
  width: number;
  quality?: number;
}) {
  const params = [`width=${width}`, `quality=${quality || 75}`, 'format=auto'];
  return `/cdn-cgi/image/${params.join(',')}/${src}`;
}
```

### Step 4: wrangler.toml の作成

`frontend/wrangler.toml`:

```toml
name = "moptabi-frontend"
compatibility_date = "2024-01-01"
compatibility_flags = ["nodejs_compat"]
pages_build_output_dir = ".vercel/output/static"
```

### Step 5: 環境変数の設定（Cloudflare Dashboard）

| 変数名 | 説明 | Staging | Production |
|--------|------|---------|------------|
| `NEXT_PUBLIC_API_URL` | Backend API URL | `https://staging.api-moptabi...` | `https://api-moptabi...` |
| `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY` | Clerk公開キー | Staging用 | Production用 |
| `CLERK_SECRET_KEY` | Clerkシークレットキー | Staging用 | Production用 |

### Step 6: Cloudflare Pages の設定

Cloudflare Dashboardで：

1. Pages > プロジェクト設定
2. ビルド設定：
   - **Build command**: `npm run build`
   - **Build output directory**: `.next`
3. プレビューブランチ：`staging`
4. 本番ブランチ：`master`

---

## Staging環境での確認項目

### チェックリスト

stagingブランチにプッシュ後、以下の項目を確認してください：

#### 基本動作
- [ ] トップページが表示される
- [ ] ログイン/ログアウトが正常に動作する
- [ ] ユーザー登録が正常に動作する

#### API連携
- [ ] APIリクエストが正常に送信される（CORSエラーなし）
- [ ] 認証トークンが正しく送信される
- [ ] エラーハンドリングが正常に動作する

#### データベース
- [ ] データの取得が正常に動作する
- [ ] データの作成・更新・削除が正常に動作する
- [ ] トランザクションが正常に動作する

#### 旅行プラン機能
- [ ] 旅行プラン一覧が表示される
- [ ] 旅行プラン詳細が表示される
- [ ] 旅行プランの作成ができる
- [ ] 旅行プランの削除ができる

#### 行きたい場所（Wishlist）機能
- [ ] 行きたい場所一覧が表示される
- [ ] 行きたい場所の追加ができる
- [ ] 行きたい場所の削除ができる

#### 画像表示
- [ ] 旅行プランのサムネイル画像が表示される
- [ ] スポット画像が表示される
- [ ] 画像のアップロードが正常に動作する

#### パフォーマンス
- [ ] ページ読み込み速度が許容範囲内
- [ ] API応答時間が許容範囲内

#### その他
- [ ] レスポンシブデザインが正常に動作する
- [ ] エラーページが正しく表示される
- [ ] 404ページが正しく表示される

---

## Productionリリース手順

### 前提条件

- [ ] Staging環境での全確認項目がパス
- [ ] コードレビュー完了
- [ ] マイグレーションが本番DBに適用済み

### Step 1: 本番データベースのマイグレーション

```bash
cd backend

# 本番環境の接続文字列を設定
export DIRECT_DATABASE_URL="postgresql://..."

# マイグレーション実行
npx prisma migrate deploy
```

### Step 2: stagingブランチをmasterにマージ

```bash
git checkout master
git pull origin master
git merge staging
git push origin master
```

### Step 3: デプロイの確認

1. Cloudflare Dashboardでデプロイステータスを確認
2. Backend: Workers > デプロイメント履歴
3. Frontend: Pages > デプロイメント履歴

### Step 4: 本番環境の動作確認

- [ ] 全機能が正常に動作することを確認
- [ ] エラーログを監視
- [ ] パフォーマンスメトリクスを確認

### Step 5: リリース完了報告

- 関係者にリリース完了を報告
- 必要に応じてリリースノートを作成

---

## トラブルシューティング

### よくある問題と解決方法

#### 1. CORSエラー

**症状**: フロントエンドからAPIリクエスト時にCORSエラーが発生

**解決方法**:
`backend/src/index.ts` のCORS設定を確認：

```typescript
app.use(
  '*',
  cors({
    origin: [
      'https://moptabi.pages.dev',
      'https://staging.moptabi.pages.dev',
      'http://localhost:3000',
    ],
    allowMethods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH'],
    allowHeaders: ['Content-Type', 'Authorization', 'X-Clerk-Auth'],
    credentials: true,
  }),
);
```

#### 2. データベース接続エラー

**症状**: Prisma Accelerate経由の接続が失敗

**解決方法**:
1. `DATABASE_URL` がPrisma Accelerate形式（`prisma://...`）か確認
2. Prisma Data Platformでプロジェクトのステータスを確認
3. APIキーの有効期限を確認

#### 3. 認証エラー

**症状**: Clerk認証が失敗

**解決方法**:
1. 環境変数 `CLERK_PUBLISHABLE_KEY` と `CLERK_SECRET_KEY` が正しいか確認
2. Clerkダッシュボードでドメイン設定を確認
3. staging/production で異なるClerkインスタンスを使用しているか確認

#### 4. 画像が表示されない

**症状**: 画像のURLが正しく生成されない、または表示されない

**解決方法**:
1. `next.config.ts` の `images` 設定を確認
2. 画像ホスティング先のCORS設定を確認
3. 画像URLのプロトコル（http/https）を確認

#### 5. ビルドエラー（Frontend）

**症状**: Cloudflare Pagesでビルドが失敗

**解決方法**:
1. ローカルで `npm run build` を実行してエラーを確認
2. Node.jsバージョンを確認（Cloudflareダッシュボードで設定可能）
3. 依存関係のバージョン互換性を確認

---

## 参考リンク

- [Cloudflare Workers ドキュメント](https://developers.cloudflare.com/workers/)
- [Cloudflare Pages ドキュメント](https://developers.cloudflare.com/pages/)
- [Prisma Accelerate ドキュメント](https://www.prisma.io/docs/accelerate)
- [Clerk ドキュメント](https://clerk.com/docs)
- [Hono on Cloudflare Workers](https://hono.dev/docs/getting-started/cloudflare-workers)
- [Next.js on Cloudflare Pages](https://developers.cloudflare.com/pages/framework-guides/nextjs/)

---

## 更新履歴

| 日付 | バージョン | 変更内容 |
|------|------------|----------|
| 2026-01-19 | 1.0.0 | 初版作成 |
