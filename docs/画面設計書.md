# AI旅行計画プランナー 画面設計書

## 概要
AI旅行計画プランナーは、ユーザーが効率的に旅行プランを作成・管理できるWebアプリケーションです。Google Maps APIを活用して観光スポットの検索・選択を行い、最適なルートとスケジュールを提案します。

## アプリケーション上限

ユーザーエクスペリエンスとシステムパフォーマンスを最適化するため、以下の上限を設定しています:

| 項目 | 上限値 | 理由 |
|------|--------|------|
| 行きたいリスト登録数 | 100件 | 管理しやすい件数と画面表示の最適化 |
| プラン作成数 | 20件 | データ量の管理とパフォーマンス維持 |
| 1日あたりスポット数 | 10件 | 現実的な旅程と画面レイアウトの制約 |
| プラン日数 | 7日 | 一般的な旅行期間とUI/UXの最適化 |

上限に達した場合:
- ユーザーにトースト通知で警告
- 追加ボタンを無効化
- 上限値と現在の登録数を表示

### 件数表示機能（LimitDisplay）

各画面で現在の登録数と上限値を視覚的に表示するコンポーネントを提供:

| 表示場所 | 表示内容 | 備考 |
|----------|----------|------|
| 行きたいリスト画面 | 「X / 100件」 | ヘッダーにタイトルと並列表示 |
| プラン一覧画面 | 「X / 20件」 | ヘッダーにタイトルと並列表示 |
| プラン作成画面（日付選択） | 「旅行日数 X / 7日」 | 日付選択エリアに表示 |
| スポット検索ダイアログ | 「本日のスポット X / 10件」 | ダイアログヘッダーに表示 |

**スタイル**:
- 通常（~79%）: グレー
- 注意（80%~89%）: イエロー
- 警告（90%~）: レッド

**スポット追加時の上限警告**:
- 1日あたりのスポット数が上限に達した場合:
  - ダイアログ内に警告メッセージを表示
  - 「あとX件追加できます」の残数表示（残り3件以下の場合）
  - スポット選択時にトースト通知で警告

## 技術スタック
- **フロントエンド**: Next.js 15.2.3, React 18.3.1, TypeScript
- **UIライブラリ**: Radix UI, Tailwind CSS, shadcn/ui
- **状態管理**: Zustand
- **認証**: Clerk
- **地図**: Google Maps API
- **バックエンド**: Hono, Prisma, PostgreSQL

## 画面一覧

### 0. お知らせ機能(全画面共通)
**目的**: 管理者からのシステムお知らせを確認と管理

**お知らせの種類**:
| 種類 | 説明 | 例 |
|------|------|-----|
| SYSTEM | 管理者からのシステムお知らせ | メンテナンス告知、新機能リリース |
| INFO | 一般的な情報 | Tips、使い方ガイド |

**主要要素**:
- ヘッダーの通知アイコン（ベルアイコン）
- 未読件数バッジ表示
- お知らせ一覧ドロップダウン/モーダル

**機能**:
- お知らせ一覧の取得・表示
- お知らせの既読/未読管理
- 未読お知らせの件数表示
- お知らせの詳細表示

**お知らせ一覧の表示内容**:
| 項目 | 説明 |
|------|------|
| タイトル | お知らせのタイトル |
| 内容（プレビュー） | 本文の先頭50文字程度 |
| 種類アイコン | SYSTEM/INFOに応じたアイコン |
| 日時 | 作成日時（相対表示: 「3時間前」など） |
| 既読状態 | 未読の場合はドット表示 |

**将来対応（Phase 2以降）**:
- リアルタイム通知（WebSocket）
- 他ユーザーからのアクション通知

### 1. ホーム画面 (`/`)
**目的**: アプリケーションの紹介とユーザーの導線確保

**主要要素**:
- ヒーローセクション（背景画像付き）
- アプリケーションの説明文
- 「今すぐ試す」ボタン（認証状態に応じて表示切り替え）
- 機能紹介セクション

**機能**:
- 未認証ユーザー: ログインボタン表示
- 認証済みユーザー: プラン作成画面への遷移

### 2. プラン作成画面 (`/plan/create`)
**目的**: 新しい旅行プランの作成

**主要要素**:
- プラン基本情報入力フォーム
  - タイトル入力
  - 開始日・終了日選択（カレンダー）
  - 画像アップロード
- 日別プラン設定タブ
- 各日の詳細設定

**機能**:
- 日付範囲選択（最大14日）
- 日別プラン設定
- リアルタイムバリデーション
- プラン日数の上限チェック

### 3. 日別プラン設定画面
**目的**: 特定日の詳細な旅行プラン設定

**主要要素**:
- 移動手段選択(徒歩と車と自転車のみ TODO:公共交通機関は対応できていないため)
- 出発地設定
- 目的地設定
- 備考入力
- スポット選択
- ガントチャート（タイムライン）
- プラン作成ボタン

**機能**:
- Google Maps APIを使用したスポット検索
- ドラッグ&ドロップによるスポット順序変更
- 移動時間・コストの自動計算
- リアルタイムプレビュー
- 1日あたりスポット数の上限チェック（最大10件）

#### スポット検索機能

- 概要: Google Places API の「Nearby Search」と「Text Search」を用いてスポットを検索し、結果を一覧/地図に表示して選択・追加する。

##### 検索方式
- Nearby Search: 地図上の中心点と半径で範囲検索。
- Text Search: 入力キーワードで検索。
- 営業時間フィルターは後ほど追加

##### 検索条件
- 検索中心の選択肢:
  - デフォルト: 東京駅
  - 各都道府県の中心地（仮: 市役所）
  - 出発地 / 目的地 / 現在地
  - 既に選択されているスポット
- 検索半径:
  - 1km〜10km（単位: km、UI: スライダーまたはセレクト）
- カテゴリ:
  - 観光スポット（`tourist_attraction`）
  - 歴史文化（`historical_place`）
  - 公園・自然（`park`）
  - グルメ（`restaurant`）
  - 美術館・博物館（`museum`）
  - レジャー（`amusement_park`）
  - その他（検討）

##### 補助UI（中心地調整モーダル）
- 選択した中心地にピン表示、半径円を重ねる。
- クリックでピン移動、円も追従。
- ピン移動後は元の中心地選択（都道府県/出発地/目的地/現在地）は未選択状態に戻す。
- 確定時、設定に応じて検索を実行。

##### フィルター
- レビュー評価 4.0 以上
- 計画時点での営業の有無（`opening_hours`）
- その他（検討）
- 複合フィルターは AND で適用（明記）

##### 表示
- 並び順: 人気順（`popularity`）。距離順は当面非対応。
- 件数: 最大 20 件 (APIの最大数が20件のため)
- 検索結果のスポットカードの表示内容
  - Google検索
    - 画像(現時点は仮画像(課金対策等できれば追加予定))
    - スポット名
    - 評価
    - 評価数
    - 住所
    - 外部リンク
  - 行きたいリスト
    - 画像(現時点は仮画像(課金対策等できれば追加予定))
    - スポット名
    - 評価
    - 住所
    - 外部リンク
    - 登録日時
  - 過去のスポット
    - 画像(現時点は仮画像(課金対策等できれば追加予定))
    - スポット名
    - 評価
    - 住所
    - 外部リンク
    - 訪問回数
    - 前回訪問日時(YYYY-MM-DD)

##### 結果の取り扱い
- 地図とリストの同期: ホバーで相互ハイライト、ピン/カードクリックで同期スクロール

##### キーワード検索（Text Search）
- 入力値を Places API に渡して結果取得
- 同様のフィルター適用可
- 入力バリデーション（空文字/過剰文字数）とデバウンスを実装

##### 行きたいリストからの登録
- 未訪問のスポットを抽出
- 表示順候補: 優先度の高い順
- フィルター候補: 都道府県、優先度、営業時間内

##### 過去に行ったスポットからの登録
- 取得条件:
  - 行きたいリストで訪問済み
  - 計画として登録している出発地/目的地以外のスポット
- 表示順候補:
  - 行きたいリストで訪問済み → 計画として登録したスポット
  - 計画した日付または訪問済み日付が計画時点から近い順
  - 行ったことのある回数が多い順
- フィルター候補:
  - 都道府県
  - 日付（範囲指定）
  - 営業時間内
  - 行ったことのある回数が多い順
##### 追加仕様
  - 押下することでガントチャートにスポットが登録される(後ほど仕様を行きたいリストと合わせるか?)
  - 基本的には1時間単位で登録される
  - 追加時にスポットが既に登録されている場合は,前回追加スポットの終了時間が開始時間となるようにセットされる
  - 追加したスポットは選択済みのアイコンが表示されている

##### エッジケース/フォールバック
- API クォータ超過時はリトライ/案内 - 後ほど定義

#### 旅行計画のプレビュー機能(TravelPlan.tsx)
**機能**
- Google Map上に各スポット間の距離と移動時間の表示
- その日の総移動距離と総移動時間
- Google Map上に各スポット間のルート表示
- 各スポットにスポットの詳細情報表示:(出発地と目的地は名称とメモ機能のみ)
 - 各スポットの名称
 - 各スポットの滞在時間
 - 各スポットのイメージ画像(仮画像)
 - 評価
 - カテゴリ(3つまで)
 - 各スポットの説明
 - 各スポットの外部URL
 - 各スポットの営業時間
 - 各スポットのメモ機能
 - 各スポットの住所
 - 各スポットの間の移動時間と交通手段表示
 - 各スポットの個別削除機能

### 4. プラン一覧画面 (`/plan/list`)
**目的**: 作成済みプランの一覧表示と管理

**主要要素**:
- プラン一覧カード
- 検索・フィルタリング機能
- プラン詳細表示
- 編集・削除ボタン
- プラン数表示（現在のプラン数 / 上限20件）

**機能**:
- プランの検索・フィルタリング
- プランの編集・削除
- プラン詳細表示
- 現在の作成済みプラン数と作成可能上限のプラン数の表示

### 5. プラン詳細画面 (`/plan/[id]`)
**目的**: 特定プランの詳細表示と編集

**主要要素**:
- プラン基本情報
- 日別スケジュール表示
- 地図表示
- スポット詳細情報
- ルート情報

**機能**:
- プラン詳細表示
- 地図上でのルート表示
- スポット情報の詳細表示
- プラン編集

#### プラン詳細表示
- 各スポットにスポットの詳細情報表示:(出発地と目的地は名称とメモ機能のみ)
 - 各スポットの名称
 - 各スポットの滞在時間
 - 各スポットのイメージ画像(仮画像)
 - 評価
 - カテゴリ(3つまで)
 - 各スポットの説明
 - 各スポットの外部URL
 - 各スポットの営業時間
 - 各スポットのメモ機能
 - 各スポットの住所
 - 各スポットの間の移動時間と交通手段表示

### 6. 行きたいリスト(`/wishlist`)
**目的** 計画を練る前にあらかじめ行きたいと思ったスポットの一覧を表示または追加を行う。
またここで追加した行きたいリストを旅行計画策定時にリストとして一覧表示を行い、計画の策定の利便性向上を目的とする。

**主要要素**:
- 行きたいリストの件数表示（現在の件数 / 上限100件）

**機能**:
- 行きたいリストの一覧表示
- 行きたいリストのMap View表示
- 行きたいリストの情報に応じたフィルター機能(都道府県, 優先度, 評価, 訪問ステータス)
- 行きたいリストの追加機能(メモや優先度、訪問日、訪問ステータス)
- 行きたいリストに追加するためのスポットの検索機能（Nearby Search, Text Search）
- 検索スポットの詳細情報の表示

#### 訪問日時機能
**目的**: 実際にスポットを訪問した日時を記録し、訪問履歴の管理を可能にする。

**仕様**:
- **初期値**: 訪問日時の初期値はなし（未設定状態）
- **表記**: YYYY-mm-dd形式

- **訪問済み登録時の動作**:
  - 訪問日時を入力した状態で「訪問済みにする」ボタンを押すと、入力した訪問日時がDBに登録される
  - 訪問日時が未入力のまま訪問済み登録した場合、本日の日付が自動的に設定される
  - 訪問日時はステータスが訪問済みの場合のみ更新できる
- **未訪問に戻す時の動作**:
  - 「未訪問に戻す」ボタンを押すと、訪問日時はリセット（null）される
  - ローカルの入力状態もクリアされる

**UIコンポーネント**:
- カレンダーアイコン付きボタンでPopoverを開く
- Calendarコンポーネントで日付を選択
- 選択した日付はボタン上に表示（YYYY-MM-DD形式）
- 訪問済みの場合は登録済みの訪問日時を表示

### 7. マイページ (`/mypage`)
**目的**: ユーザーの旅の活動状況を可視化し、次の旅へのモチベーションを高めるダッシュボード

**コンセプト**:
- 「いつでも旅を楽しめる」「旅の意欲を刺激する」
- ターゲット: 一人旅〜少人数での旅行者

**主要要素**:

#### プロフィールセクション
| 項目 | 仕様 |
|------|------|
| ユーザーアイコン | Clerkから取得（`user.imageUrl`） |
| ユーザー名 | Clerkから取得（`user.fullName` or `user.firstName`） |
| メールアドレス | Clerkから取得（`user.primaryEmailAddress`） |

#### 次の旅セクション
| 状態 | 表示内容 |
|------|----------|
| 未来のプランあり | プランタイトル、開始日、「あと○日」、詳細リンク |
| 未来のプランなし | 「次の旅を計画しませんか？」メッセージ、行きたいリスト件数、プラン作成リンク |

**判定ロジック**:
- 全プランから `startDate > 今日` のものを抽出
- 最も近い日付のプランを「次の旅」として表示

#### 旅のサマリーカード（3枚）
| カード | データソース | 計算方法 |
|--------|-------------|----------|
| 訪問済みスポット | Wishlist API | `visited === 1` の件数 |
| 行きたいスポット | Wishlist API | `visited === 0` の件数 |
| 旅した日数 | Trip API | 過去プランの `startDate` 〜 `endDate` の日数を合計 |

#### 利用状況
| 項目 | データソース |
|------|-------------|
| プラン数 | `GET /trips/count` |
| 行きたいリスト数 | `GET /wishlist/count` |

#### 最近の旅
| 項目 | 仕様 |
|------|------|
| 表示件数 | 最大3件 |
| ソート | `startDate` 降順（新しい順）、過去のプランのみ |
| 表示内容 | プランタイトル、開始日 |
| リンク | プラン一覧画面へ遷移 |

#### アカウントセクション
- ログアウトボタン（Clerk `SignOutButton` 使用）

**画面遷移**:
- [詳細を見る] → `/plan/[id]`（次の旅のプラン詳細）
- [プランを作成する] → `/plan/create`
- [すべて見る] → `/plan/list`
- [ログアウト] → `/`（ホーム画面）

## 共通コンポーネント

### ヘッダー
- ロゴ・アプリ名
- ナビゲーションメニュー
- 認証状態表示
- 通知機能

### フッター
- アプリケーション情報
- リンク集

## レスポンシブデザイン
- モバイルファーストデザイン
- タブレット・デスクトップ対応
- ブレークポイント: sm(640px), md(768px), lg(1024px), xl(1280px)

## アクセシビリティ
- ARIA属性の適切な使用
- キーボードナビゲーション対応
- スクリーンリーダー対応
- コントラスト比の確保

## 状態管理
- Zustandを使用したグローバル状態管理
- フォーム状態の管理
- エラーハンドリング
- ローディング状態の管理

## エラーハンドリング
- バリデーションエラーの表示
- API エラーの適切な処理
- ユーザーフレンドリーなエラーメッセージ
- フォールバック UI の提供
