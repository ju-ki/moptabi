# AI旅行計画プランナー 環境詳細書

## 概要
AI旅行計画プランナーの開発・本番環境の詳細設定とセットアップ手順を記載したドキュメントです。

## アーキテクチャ概要

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Frontend      │    │   Backend       │    │   Database      │
│   (Next.js)     │◄──►│   (Hono)        │◄──►│   (PostgreSQL)  │
│   Port: 3000    │    │   Port: 8787    │    │   Port: 5432    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                    ┌─────────────────┐
                    │   Prisma Studio │
                    │   Port: 5555    │
                    └─────────────────┘
```

## 開発環境

### Docker Compose設定
**ファイル**: `docker-compose.yml`

#### サービス構成
1. **frontend** (Next.js)
   - ポート: 3000
   - ベースイメージ: Node.js (Dockerfile.frontend)
   - 環境変数: DATABASE_URL

2. **backend** (Hono)
   - ポート: 8787
   - ベースイメージ: Node.js (Dockerfile.backend)
   - 環境変数: DATABASE_URL, WATCHPACK_POLLING

3. **dev-db** (PostgreSQL)
   - ポート: 5432
   - データベース: ai_travel
   - ユーザー: travel_user
   - パスワード: travel_admin

4. **prisma-studio**
   - ポート: 5555
   - Prisma Studio管理画面

### 環境変数

#### Frontend環境変数
```bash
# .env.local
NEXT_PUBLIC_API_BASE_URL=http://localhost:8787
NEXT_PUBLIC_GOOGLE_MAP_API_KEY=your_google_maps_api_key
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=your_clerk_publishable_key
```

#### Backend環境変数
```bash
# .env
DATABASE_URL=postgresql://travel_user:travel_admin@dev-db:5432/ai_travel
CLERK_SECRET_KEY=your_clerk_secret_key
```

## 技術スタック詳細

### Frontend
- **フレームワーク**: Next.js 15.2.3
- **言語**: TypeScript 5.3.3
- **UI**: React 18.3.1
- **スタイリング**: Tailwind CSS 3.4.1
- **UIコンポーネント**: Radix UI, shadcn/ui
- **状態管理**: Zustand 5.0.1
- **認証**: Clerk 6.5.0
- **地図**: Google Maps API (@react-google-maps/api 2.20.6)
- **フォーム**: React Hook Form 7.53.2
- **バリデーション**: Zod 3.23.8
- **データフェッチ**: SWR 2.3.3
- **ドラッグ&ドロップ**: @dnd-kit
- **日付処理**: react-day-picker 8.10.1

### Backend
- **フレームワーク**: Hono 3.10.0
- **言語**: TypeScript
- **ランタイム**: Bun 1.2.9
- **ORM**: Prisma 6.6.0
- **認証**: Clerk Backend 1.25.5
- **API文書**: Swagger UI (@hono/swagger-ui 0.5.1)
- **バリデーション**: Zod OpenAPI (@hono/zod-openapi 0.19.2)

### Database
- **DBMS**: PostgreSQL
- **ORM**: Prisma Client
- **接続**: Prisma Client 6.6.0

## セットアップ手順

### 1. 前提条件
- Docker & Docker Compose
- Node.js 18以上
- Bun (バックエンド用)

### 2. リポジトリクローン
```bash
git clone <repository-url>
cd ai-travel-planner
```

### 3. 環境変数設定
```bash
# Frontend環境変数
cp frontend/.env.example frontend/.env.local
# 必要なAPIキーを設定

# Backend環境変数
cp backend/.env.example backend/.env
# 必要なAPIキーを設定
```

### 4. Docker環境起動
```bash
# 全サービス起動
docker-compose up -d

# 個別起動
docker-compose up -d dev-db
docker-compose up -d backend
docker-compose up -d frontend
```

### 5. データベース初期化
```bash
# マイグレーション実行
docker-compose exec backend npx prisma migrate dev

# シードデータ投入（必要に応じて）
docker-compose exec backend npx prisma db seed
```

### 6. 開発サーバー起動
```bash
# Frontend
cd frontend
npm install
npm run dev

# Backend
cd backend
bun install
bun run dev
```

## アクセスURL

| サービス | URL | 説明 |
|---------|-----|------|
| Frontend | http://localhost:3000 | メインアプリケーション |
| Backend API | http://localhost:8787 | REST API |
| Prisma Studio | http://localhost:5555 | データベース管理画面 |
| PostgreSQL | localhost:5432 | データベース |

## 開発ツール

### コード品質
- **ESLint**: コード品質チェック
- **Prettier**: コードフォーマット
- **Husky**: Git hooks
- **lint-staged**: ステージング前のリント

### パッケージ管理
- **Frontend**: npm
- **Backend**: Bun

### データベース管理
- **Prisma Studio**: データベースGUI
- **Prisma CLI**: マイグレーション管理

## デプロイメント

### 本番環境
- **Frontend**: Vercel推奨
- **Backend**: Cloudflare Workers推奨
- **Database**: PostgreSQL (Supabase, PlanetScale等)

### 環境変数（本番）
```bash
# Frontend
NEXT_PUBLIC_API_BASE_URL=https://api.yourdomain.com
NEXT_PUBLIC_GOOGLE_MAP_API_KEY=production_key
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=production_key

# Backend
DATABASE_URL=postgresql://user:password@host:port/database
CLERK_SECRET_KEY=production_secret_key
```

## トラブルシューティング

### よくある問題

1. **ポート競合**
   ```bash
   # 使用中のポートを確認
   lsof -i :3000
   lsof -i :8787
   lsof -i :5432
   ```

2. **データベース接続エラー**
   ```bash
   # データベースコンテナの状態確認
   docker-compose ps dev-db
   
   # ログ確認
   docker-compose logs dev-db
   ```

3. **Prisma接続エラー**
   ```bash
   # スキーマの再生成
   docker-compose exec backend npx prisma generate
   
   # データベースリセット
   docker-compose exec backend npx prisma migrate reset
   ```

### ログ確認
```bash
# 全サービスのログ
docker-compose logs

# 特定サービスのログ
docker-compose logs frontend
docker-compose logs backend
docker-compose logs dev-db
```

## セキュリティ

### APIキー管理
- 環境変数での管理
- 本番環境での適切な権限設定
- 定期的なキーローテーション

### データベースセキュリティ
- 適切なユーザー権限設定
- 接続の暗号化
- 定期的なバックアップ

## 監視・メンテナンス

### ヘルスチェック
- Frontend: `/api/health`
- Backend: `/health`
- Database: 接続テスト

### バックアップ
```bash
# データベースバックアップ
docker-compose exec dev-db pg_dump -U travel_user ai_travel > backup.sql

# 復元
docker-compose exec -T dev-db psql -U travel_user ai_travel < backup.sql
```
