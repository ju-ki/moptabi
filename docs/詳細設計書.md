# AI旅行計画プランナー 詳細設計書

## 概要
AI旅行計画プランナーの詳細なシステム設計、コンポーネント設計、API設計、ビジネスロジック設計について記載したドキュメントです。

## システムアーキテクチャ

### 全体構成
```
┌─────────────────────────────────────────────────────────────┐
│                    Frontend (Next.js)                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   Pages     │  │ Components  │  │   Hooks     │        │
│  │             │  │             │  │             │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   Store     │  │   Utils     │  │   Types     │        │
│  │ (Zustand)   │  │             │  │             │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
                                │
                                │ HTTP/HTTPS
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                    Backend (Hono)                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │  Routes     │  │ Controllers │  │   Models    │        │
│  │             │  │             │  │             │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │  Middleware │  │   Auth      │  │   Utils     │        │
│  │             │  │  (Clerk)    │  │             │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
                                │
                                │ Prisma ORM
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                 Database (PostgreSQL)                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │    Trip     │  │    Plan     │  │    Spot     │        │
│  │             │  │             │  │             │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ Transport   │  │    User     │  │   Others    │        │
│  │             │  │             │  │             │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
```

## フロントエンド詳細設計

### ページ構成

#### 1. ホームページ (`/`)
**ファイル**: `frontend/src/app/(home)/page.tsx`

**主要コンポーネント**:
- ヒーローセクション
- 機能紹介カード
- 認証状態に応じたCTAボタン

**状態管理**:
- 認証状態: Clerk
- 静的コンテンツ: なし

#### 2. プラン作成ページ (`/plan/create`)
**ファイル**: `frontend/src/app/plan/create/page.tsx`

**主要コンポーネント**:
- プラン基本情報フォーム
- 日別プラン設定タブ
- 日付範囲選択カレンダー

**状態管理**:
- フォーム状態: `useStoreForPlanning` (Zustand)
- バリデーション: Zod schema

#### 3. プラン一覧ページ (`/plan/list`)
**ファイル**: `frontend/src/app/plan/list/page.tsx`

**主要コンポーネント**:
- プラン検索フォーム
- プランカード一覧
- フィルタリング機能

**状態管理**:
- データフェッチ: SWR
- 検索状態: ローカル状態

#### 4. プラン詳細ページ (`/plan/[id]`)
**ファイル**: `frontend/src/app/plan/[id]/page.tsx`

**主要コンポーネント**:
- プラン詳細表示
- 地図表示
- スポット詳細情報

**状態管理**:
- データフェッチ: SWR
- 地図状態: Google Maps API

### コンポーネント設計

#### 共通コンポーネント

##### Header (`frontend/src/components/common/header.tsx`)
**目的**: アプリケーション全体のナビゲーション

**Props**:
- なし（グローバルコンポーネント）

**機能**:
- ロゴ・アプリ名表示
- 認証状態に応じたナビゲーション
- 通知機能
- レスポンシブメニュー

##### Button (`frontend/src/components/ui/button.tsx`)
**目的**: 再利用可能なボタンコンポーネント

**Props**:
```typescript
interface ButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
  variant?: 'default' | 'primary' | 'destructive' | 'outline' | 'secondary' | 'ghost' | 'link' | 'white' | 'secondary-outline' | 'ghost-subtle';
  size?: 'default' | 'sm' | 'lg' | 'icon';
  asChild?: boolean;
}
```

**機能**:
- 複数のバリアントとサイズ
- アクセシビリティ対応
- アイコンサポート

#### 機能別コンポーネント

##### PlanningComp (`frontend/src/components/PlanningComp.tsx`)
**目的**: 日別プラン設定のメインコンポーネント

**Props**:
```typescript
interface PlanningCompProps {
  date: string;
}
```

**子コンポーネント**:
- Transportation: 移動手段選択
- Departure: 出発地設定
- Destination: 目的地設定
- SpotSelection: スポット選択
- GanttChart: タイムライン表示
- PlanningButton: プラン作成ボタン
- TravelPlan: プラン表示

##### DayPlan (`frontend/src/components/DayPlan.tsx`)
**目的**: 特定日のプラン詳細表示

**Props**:
```typescript
interface DayPlanProps {
  plan: ResponsePlanType;
  dayNumber: number;
}
```

**子コンポーネント**:
- SpotInfoCard: スポット情報カード
- RouteSummary: ルート概要
- SpotSummary: スポット概要

##### TripDetail (`frontend/src/components/TripDetail.tsx`)
**目的**: 旅行プランの詳細表示

**Props**:
```typescript
type TripDetailProps = {
  trip: {
    title: string;
    startDate: string;
    endDate: string;
    tripInfo: TripInfo[];
    plans: Plan[];
  };
};
```

### 状態管理設計

#### Zustand Store (`frontend/src/lib/plan.ts`)

##### FormState Interface
```typescript
interface FormState {
  // 基本情報
  id?: string;
  title: string;
  imageUrl?: string;
  startDate: string;
  endDate: string;
  
  // データ配列
  tripInfo: TripInfo[];
  transportMaster: TransportMethods[];
  plans: TravelPlanType[];
  departureHistory: Coordination[];
  destinationHistory: Coordination[];
  
  // エラー状態
  errors: Partial<Record<keyof FormData, string>>;
  tripInfoErrors: Partial<Record<string, Partial<Record<keyof TripInfo, string>>>>;
  planErrors: Record<string, Record<PlanErrorType, string>>;
  spotErrors: Partial<Record<string, Partial<Record<keyof Spot, string>>>>;
  
  // シミュレーション状態
  simulationStatus: { date: string; status: number }[] | null;
  
  // アクション関数
  setDepartureHistory: (history: Coordination[]) => void;
  setDestinationHistory: (history: Coordination[]) => void;
  getTripInfo: (date: string) => TripInfo;
  setTripInfo: (date: string, name: string, value: any) => void;
  // ... その他のアクション関数
}
```

##### 主要アクション関数

**setSpots**: スポットの追加・更新・削除
```typescript
setSpots: (date: string, spot: Spot, isDeleted: boolean) => void
```

**editSpots**: スポットの編集
```typescript
editSpots: (date: string, spotId: string, updatedSpot: Partial<Spot>) => void
```

**getSpotInfo**: 日付とタイプに基づくスポット取得
```typescript
getSpotInfo: (date: string, type: TransportNodeType) => Spot[]
```

### ビジネスロジック設計

#### スポット検索 (`frontend/src/lib/plan.ts`)

##### searchSpots関数
**目的**: Google Places APIを使用したスポット検索

**パラメータ**:
```typescript
interface SearchSpotByCategoryParams {
  center: { lat: number; lng: number };
  radius: number;
  genreIds?: number[];
  searchWord?: string;
  maxResultLimit: number;
  sortOption: 'distance' | 'popularity' | 'relevance';
}
```

**処理フロー**:
1. Google Places APIライブラリの読み込み
2. 検索条件の設定
3. ジャンルIDからGoogle Placesタイプへの変換
4. テキスト検索または近隣検索の実行
5. 結果のSpotオブジェクトへの変換

#### ルート計算 (`frontend/src/lib/plan.ts`)

##### getRoute関数
**目的**: Google Directions APIを使用したルート計算

**パラメータ**:
```typescript
interface RouteParams {
  origin: { lat: number; lng: number };
  destination: { lat: number; lng: number };
  travelMode: TravelModeType;
}
```

**戻り値**:
```typescript
interface RouteResult {
  path: google.maps.LatLngLiteral[];
  distance: string;
  duration: string;
  travelMode: TravelModeType;
}
```

#### アルゴリズム (`frontend/src/lib/algorithm.ts`)

##### 時間計算関数
```typescript
function calculateDuration(durationProps: DurationProps): string
```

##### ルート計算関数
```typescript
function calcRoutes(
  fromCoordination: Coordination,
  toCoordination: Coordination,
  transportMethod: TravelModeType
): Promise<RouteResult>
```

## バックエンド詳細設計

### API設計

#### 認証API

##### GET `/api/auth`
**目的**: ユーザーの存在チェックと新規登録

**認証**: Clerk認証必須

**レスポンス**:
- 200: 既存ユーザー
- 201: 新規ユーザー登録完了
- 401: 認証失敗
- 500: サーバーエラー

#### 旅行プランAPI

##### GET `/api/trips`
**目的**: 全旅行プランの取得

**認証**: Clerk認証必須

**レスポンス**:
```typescript
TripSchema[]
```

##### POST `/api/trips/create`
**目的**: 新規旅行プランの作成

**認証**: Clerk認証必須

**リクエストボディ**:
```typescript
TripSchema
```

**レスポンス**:
```typescript
TripSchema
```

##### GET `/api/trips/{id}`
**目的**: 特定旅行プランの詳細取得

**認証**: Clerk認証必須

**パラメータ**:
- `id`: 旅行プランID（数値）

**レスポンス**:
```typescript
TripSchema
```

##### DELETE `/api/trips/{id}`
**目的**: 旅行プランの削除

**認証**: Clerk認証必須

**パラメータ**:
- `id`: 旅行プランID（数値）

**レスポンス**:
```typescript
{ message: string }
```

#### 画像API

##### POST `/api/trips/upload`
**目的**: 画像のアップロード

**認証**: Clerk認証必須

**レスポンス**:
```typescript
{ url: string }
```

##### GET `/api/trips/{fileName}`
**目的**: 画像の取得

**認証**: 不要

**パラメータ**:
- `fileName`: ファイル名

#### 移動手段API

##### GET `/api/transport`
**目的**: 移動手段マスタの取得

**認証**: Clerk認証必須

**レスポンス**:
```typescript
Array<{
  id: number;
  name: string;
}>
```

#### 出発地・目的地履歴API

##### GET `/api/departure-and-destination`
**目的**: 出発地・目的地履歴の取得

**認証**: Clerk認証必須

**レスポンス**:
```typescript
Array<{
  id: number;
  name: string;
  lat: number;
  lng: number;
}>
```

### コントローラー設計

#### TripController (`backend/src/controllers/trip.ts`)

**主要メソッド**:
- `getTrips`: 全旅行プラン取得
- `createTrip`: 旅行プラン作成
- `getTripDetail`: 旅行プラン詳細取得
- `deleteTrip`: 旅行プラン削除

**エラーハンドリング**:
- Prismaエラーの適切な処理
- 認証エラーの処理
- バリデーションエラーの処理

#### AuthController (`backend/src/controllers/auth.ts`)

**主要メソッド**:
- `getAuthHandler`: 認証処理とユーザー登録

**処理フロー**:
1. Clerk認証の確認
2. 既存ユーザーのチェック
3. 新規ユーザーの場合はDBに登録
4. 適切なレスポンスを返却

### ミドルウェア設計

#### CORS設定
```typescript
cors({
  origin: 'http://localhost:3000',
  allowMethods: ['GET', 'POST', 'PUT', 'DELETE'],
  allowHeaders: ['Content-Type', 'Authorization', 'X-Clerk-Auth'],
  credentials: true,
  maxAge: 600,
})
```

#### Clerk認証ミドルウェア
- 全APIエンドポイントで認証を必須化
- 認証情報の自動取得
- 認証失敗時の適切なエラーレスポンス

## データベース詳細設計

### テーブル関係図

```
User (1) ----< Trip (1) ----< TripInfo
                    |
                    +----< Plan (1) ----< PlanSpot (N) ----< Spot (1) ----< SpotMeta
                    |                           |
                    +----< Transport (N) ----< TransportMethodOnTransport (N) ----< TransportMethod
                    |                           |
                    +----< NearestStation (N) ----< Spot
```

### 主要テーブル詳細

#### Trip（旅行プラン）
- 基本情報の管理
- ユーザーとの関連付け
- カスケード削除設定

#### Plan（日別プラン）
- 日付ごとのプラン管理
- スポットと移動情報の関連付け

#### Spot（スポット）
- Google Places APIのIDを主キーとして使用
- メタデータは別テーブルで管理

#### Transport（移動情報）
- スポット間の移動情報
- 複数の移動手段をサポート
- 出発地・目的地のタイプ管理

## セキュリティ設計

### 認証・認可
- Clerkを使用したOAuth認証
- JWTトークンベースの認証
- 全APIエンドポイントでの認証必須

### データ保護
- 入力値のバリデーション（Zod）
- SQLインジェクション対策（Prisma ORM）
- XSS対策（Reactの自動エスケープ）

### API セキュリティ
- CORS設定によるオリジン制限
- 適切なHTTPステータスコード
- エラー情報の適切な隠蔽

## パフォーマンス設計

### フロントエンド
- コンポーネントのメモ化
- 状態管理の最適化（Zustand）
- 画像の最適化（Next.js Image）
- コード分割（動的インポート）

### バックエンド
- データベースクエリの最適化
- 適切なインデックス設定
- レスポンスキャッシュ（必要に応じて）

### データベース
- 適切な正規化
- 外部キー制約による整合性保証
- インデックスによる検索性能向上

## エラーハンドリング設計

### フロントエンド
- フォームバリデーション（Zod）
- API エラーの適切な表示
- フォールバック UI の提供
- ローディング状態の管理

### バックエンド
- 統一されたエラーレスポンス形式
- ログ出力によるエラー追跡
- 適切なHTTPステータスコード
- 例外の適切な処理

## テスト設計

### 単体テスト
- コンポーネントのテスト
- ビジネスロジックのテスト
- API エンドポイントのテスト

### 統合テスト
- フロントエンド・バックエンド間の連携テスト
- データベース操作のテスト

### E2Eテスト
- 主要ユーザーフローのテスト
- ブラウザ間の互換性テスト

## デプロイメント設計

### 開発環境
- Docker Composeによる環境構築
- ホットリロード対応
- デバッグツールの統合

### 本番環境
- コンテナベースのデプロイメント
- 環境変数による設定管理
- ログ収集とモニタリング

## 監視・運用設計

### ログ管理
- アプリケーションログの出力
- エラーログの収集
- アクセスログの記録

### パフォーマンス監視
- レスポンス時間の監視
- データベース性能の監視
- リソース使用量の監視

### アラート設定
- エラー率の監視
- レスポンス時間の閾値監視
- リソース使用量の監視
