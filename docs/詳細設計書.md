# AI旅行計画プランナー 詳細設計書

## 概要
AI旅行計画プランナーの詳細なシステム設計、コンポーネント設計、API設計、ビジネスロジック設計について記載したドキュメントです。

## システムアーキテクチャ

### アプリケーション制約

#### 上限設定

アプリケーション全体で以下の上限値を定義しています:

**定数定義場所**:
- フロントエンド: `frontend/src/data/constants.ts` - `APP_LIMITS`
- バックエンド: `backend/src/constants/limits.ts` - `APP_LIMITS`

```typescript
export const APP_LIMITS = {
  MAX_WISHLIST_SPOTS: 100,  // 行きたいリスト最大登録数
  MAX_PLANS: 20,            // プラン最大作成数
  MAX_SPOTS_PER_DAY: 10,    // 1日あたり最大スポット数
  MAX_PLAN_DAYS: 7,        // プラン最大日数
} as const;
```

**実装方針**:
- フロントエンド: ユーザー操作前に事前チェック、UIフィードバック
- バックエンド: API実行時に確実にチェック、400エラーで拒否
- 両方でチェックすることでセキュリティと UX を両立

**エラーメッセージ**:
- `行きたいリストの登録上限（100件）に達しています`
- `プランの作成上限（20件）に達しています`
- `1日あたりのスポット登録上限（10件）に達しています`
- `プランの日数上限（7日）を超えています`

**フロントエンド上限チェック関数** (`frontend/src/lib/limits.ts`):
```typescript
// 各種上限到達チェック
isWishlistLimitReached(currentCount: number): boolean
isPlanLimitReached(currentCount: number): boolean
isSpotsPerDayLimitReached(spotCount: number): boolean
isPlanDaysLimitReached(daysCount: number): boolean

// エラーメッセージ取得
getLimitErrorMessage(type: LimitType): string

// 残り件数計算
getRemainingCount(current: number, limit: number): number

// 上限接近チェック（80%以上）
isApproachingLimit(current: number, limit: number): boolean
```

**出発地・目的地除外ユーティリティ関数** (`frontend/src/lib/utils.ts`):

1日あたりのスポット数上限チェック時、出発地と目的地は除外して計算します。

```typescript
// 出発地・目的地の判定
// departure_YYYY-MM-DD または destination_YYYY-MM-DD 形式のIDを判定
isDepartureOrDestination(spotId: string): boolean

// 出発地・目的地を除外した配列を返す
filterActualSpots<T extends { id: string }>(spots: T[]): T[]

// 出発地・目的地を除外したスポット数を返す
getActualSpotCount<T extends { id: string }>(spots: T[] | undefined): number

// 出発地・目的地のID生成
buildSpotId(prefix: 'departure' | 'destination', date: string): string
// 例: buildSpotId('departure', '2025-01-01') => 'departure_2025-01-01'
```

**使用例**:
```typescript
// SpotSelectionDialog.tsx での使用
const currentSpotCount = useMemo(() => {
  const spots = plans.find((plan) => plan.date === date)?.spots ?? [];
  return getActualSpotCount(spots); // 出発地・目的地を除外した件数
}, [plans, date]);

// 上限チェック
const isLimitReached = isSpotsPerDayLimitReached(currentSpotCount);
```

### 全体構成
```
┌─────────────────────────────────────────────────────────────┐
│                    Frontend (Next.js)                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   Pages     │  │ Components  │  │   Hooks     │        │
│  │             │  │             │  │             │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   Store     │  │   Utils     │  │   Types     │        │
│  │ (Zustand)   │  │             │  │             │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
                                │
                                │ HTTP/HTTPS
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                    Backend (Hono)                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │  Routes     │  │ Controllers │  │   Models    │        │
│  │             │  │             │  │             │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │  Middleware │  │   Auth      │  │   Utils     │        │
│  │             │  │  (Clerk)    │  │             │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
                                │
                                │ Prisma ORM
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                 Database (PostgreSQL)                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │    Trip     │  │    Plan     │  │    Spot     │        │
│  │             │  │             │  │             │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ Transport   │  │    User     │  │   Others    │        │
│  │             │  │             │  │             │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
```

## フロントエンド詳細設計

### ページ構成

#### 1. ホームページ (`/`)
**ファイル**: `frontend/src/app/(home)/page.tsx`

**主要コンポーネント**:
- ヒーローセクション
- 機能紹介カード
- 認証状態に応じたCTAボタン

**状態管理**:
- 認証状態: Clerk
- 静的コンテンツ: なし

#### 2. プラン作成ページ (`/plan/create`)
**ファイル**: `frontend/src/app/plan/create/page.tsx`

**主要コンポーネント**:
- プラン基本情報フォーム
- 日別プラン設定タブ
- 日付範囲選択カレンダー

**状態管理**:
- フォーム状態: `useStoreForPlanning` (Zustand)
- バリデーション: Zod schema

#### 3. プラン一覧ページ (`/plan/list`)
**ファイル**: `frontend/src/app/plan/list/page.tsx`

**主要コンポーネント**:
- プラン検索フォーム
- プランカード一覧
- フィルタリング機能

**状態管理**:
- データフェッチ: SWR
- 検索状態: ローカル状態

#### 4. プラン詳細ページ (`/plan/[id]`)
**ファイル**: `frontend/src/app/plan/[id]/page.tsx`

**主要コンポーネント**:
- プラン詳細表示
- 地図表示
- スポット詳細情報

**状態管理**:
- データフェッチ: SWR
- 地図状態: Google Maps API

### コンポーネント設計

#### 共通コンポーネント

##### LimitDisplay (`frontend/src/components/common/LimitDisplay.tsx`)
**目的**: 上限値と現在の登録数を視覚的に表示

**Props**:
```typescript
interface LimitDisplayProps {
  current: number;    // 現在の件数
  limit: number;      // 上限
  label: string;      // ラベル
  unit?: string;      // 単位（デフォルト: 件）
  size?: 'sm' | 'md' | 'lg';  // サイズ
  className?: string; // 追加のクラス名
}
```

**機能**:
- 現在の件数と上限値を「X / Y件」形式で表示
- 上限に対する割合に応じた色の変化:
  - 通常（~79%）: グレー (`text-gray-600`)
  - 注意（80%~89%）: イエロー (`text-yellow-600`)
  - 警告（90%~）: レッド (`text-red-600`)
- 3サイズ対応（sm, md, lg）

**使用箇所**:
- 行きたいリスト画面（ヘッダー）
- プラン一覧画面（ヘッダー）
- プラン作成画面（日付選択エリア）
- スポット検索ダイアログ（ダイアログヘッダー）

##### Header (`frontend/src/components/common/header.tsx`)
**目的**: アプリケーション全体のナビゲーション

**Props**:
- なし（グローバルコンポーネント）

**機能**:
- ロゴ・アプリ名表示
- 認証状態に応じたナビゲーション
- 通知機能
- レスポンシブメニュー

##### Button (`frontend/src/components/ui/button.tsx`)
**目的**: 再利用可能なボタンコンポーネント

**Props**:
```typescript
interface ButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
  variant?: 'default' | 'primary' | 'destructive' | 'outline' | 'secondary' | 'ghost' | 'link' | 'white' | 'secondary-outline' | 'ghost-subtle';
  size?: 'default' | 'sm' | 'lg' | 'icon';
  asChild?: boolean;
}
```

**機能**:
- 複数のバリアントとサイズ
- アクセシビリティ対応
- アイコンサポート

#### 機能別コンポーネント

##### PlanningComp (`frontend/src/components/PlanningComp.tsx`)
**目的**: 日別プラン設定のメインコンポーネント

**Props**:
```typescript
interface PlanningCompProps {
  date: string;
}
```

**子コンポーネント**:
- Transportation: 移動手段選択
- Departure: 出発地設定
- Destination: 目的地設定
- SpotSelection: スポット選択
- GanttChart: タイムライン表示
- PlanningButton: プラン作成ボタン
- TravelPlan: プラン表示

##### DayPlan (`frontend/src/components/DayPlan.tsx`)
**目的**: 特定日のプラン詳細表示

**Props**:
```typescript
interface DayPlanProps {
  plan: ResponsePlanType;
  dayNumber: number;
}
```

**子コンポーネント**:
- SpotInfoCard: スポット情報カード
- RouteSummary: ルート概要
- SpotSummary: スポット概要

##### TripDetail (`frontend/src/components/TripDetail.tsx`)
**目的**: 旅行プランの詳細表示

**Props**:
```typescript
type TripDetailProps = {
  trip: {
    title: string;
    startDate: string;
    endDate: string;
    tripInfo: TripInfo[];
    plans: Plan[];
  };
};
```

### 状態管理設計

#### Zustand Store (`frontend/src/lib/plan.ts`)

##### FormState Interface
```typescript
interface FormState {
  // 基本情報
  id?: string;
  title: string;
  imageUrl?: string;
  startDate: string;
  endDate: string;
  
  // データ配列
  tripInfo: TripInfo[];
  transportMaster: TransportMethods[];
  plans: TravelPlanType[];
  departureHistory: Coordination[];
  destinationHistory: Coordination[];
  
  // エラー状態
  errors: Partial<Record<keyof FormData, string>>;
  tripInfoErrors: Partial<Record<string, Partial<Record<keyof TripInfo, string>>>>;
  planErrors: Record<string, Record<PlanErrorType, string>>;
  spotErrors: Partial<Record<string, Partial<Record<keyof Spot, string>>>>;
  
  // シミュレーション状態
  simulationStatus: { date: string; status: number }[] | null;
  
  // アクション関数
  setDepartureHistory: (history: Coordination[]) => void;
  setDestinationHistory: (history: Coordination[]) => void;
  getTripInfo: (date: string) => TripInfo;
  setTripInfo: (date: string, name: string, value: any) => void;
  // ... その他のアクション関数
}
```

##### 主要アクション関数

**setSpots**: スポットの追加・更新・削除
```typescript
setSpots: (date: string, spot: Spot, isDeleted: boolean) => void
```

**editSpots**: スポットの編集
```typescript
editSpots: (date: string, spotId: string, updatedSpot: Partial<Spot>) => void
```

**getSpotInfo**: 日付とタイプに基づくスポット取得
```typescript
getSpotInfo: (date: string, type: TransportNodeType) => Spot[]
```

### ビジネスロジック設計

#### スポット検索 (`frontend/src/lib/plan.ts`)

##### searchSpots関数
**目的**: Google Places APIを使用したスポット検索

**パラメータ**:
```typescript
interface SearchSpotByCategoryParams {
  center: { lat: number; lng: number };
  radius: number;
  genreIds?: number[];
  searchWord?: string;
  maxResultLimit: number;
  sortOption: 'distance' | 'popularity' | 'relevance';
}
```

**処理フロー**:
1. Google Places APIライブラリの読み込み
2. 検索条件の設定
3. ジャンルIDからGoogle Placesタイプへの変換
4. テキスト検索または近隣検索の実行
5. 結果のSpotオブジェクトへの変換

#### ルート計算 (`frontend/src/lib/plan.ts`)

##### getRoute関数
**目的**: Google Directions APIを使用したルート計算

**パラメータ**:
```typescript
interface RouteParams {
  origin: { lat: number; lng: number };
  destination: { lat: number; lng: number };
  travelMode: TravelModeType;
}
```

**戻り値**:
```typescript
interface RouteResult {
  path: google.maps.LatLngLiteral[];
  distance: string;
  duration: string;
  travelMode: TravelModeType;
}
```

#### アルゴリズム (`frontend/src/lib/algorithm.ts`)

##### 時間計算関数
```typescript
function calculateDuration(durationProps: DurationProps): string
```

##### ルート計算関数
```typescript
function calcRoutes(
  fromCoordination: Coordination,
  toCoordination: Coordination,
  transportMethod: TravelModeType
): Promise<RouteResult>
```

## バックエンド詳細設計

### マイページ用カスタムフック (`frontend/src/hooks/use-mypage.ts`)

#### useMypageData

**目的**: マイページに必要なデータを一括で取得・整形するカスタムフック

**戻り値**:
```typescript
interface MypageData {
  // ローディング・エラー状態
  isLoading: boolean;
  error: Error | null;

  // 次の旅
  nextTrip: {
    id: number;
    title: string;
    startDate: string;
    daysUntil: number;
  } | null;

  // サマリー
  visitedCount: number;      // 訪問済みスポット数
  wishlistCount: number;     // 行きたいスポット数（未訪問）
  totalTripDays: number;     // 旅した総日数

  // 利用状況
  planCount: number;
  planLimit: number;
  wishlistTotalCount: number;
  wishlistLimit: number;

  // 最近の旅
  recentTrips: {
    id: number;
    title: string;
    startDate: string;
  }[];
}
```

**使用API**:
- `GET /trips` - プラン一覧
- `GET /trips/count` - プラン数・上限
- `GET /wishlist` - 行きたいリスト
- `GET /wishlist/count` - 行きたいリスト数・上限

**データ整形ロジック**:

1. **次の旅の判定**:
   - 全プランから `startDate > 今日` のものを抽出
   - 最も近い日付のプランを「次の旅」として選択
   - `daysUntil`を計算（開始日 - 今日）

2. **旅した総日数の計算**:
   - 過去のプラン（`endDate <= 今日`）を対象
   - 各プランの`startDate`〜`endDate`の日数を合計

3. **訪問済み/未訪問スポット数**:
   - 行きたいリストから`visited === 1`を訪問済みとしてカウント
   - `visited === 0`を未訪問としてカウント

4. **最近の旅**:
   - 過去のプラン（`endDate <= 今日`）を`startDate`降順でソート
   - 最大3件を取得

### API設計

#### 認証API

##### GET `/api/auth`
**目的**: ユーザーの存在チェックと新規登録

**認証**: Clerk認証必須

**レスポンス**:
- 200: 既存ユーザー
- 201: 新規ユーザー登録完了
- 401: 認証失敗
- 500: サーバーエラー

#### 旅行プランAPI

##### GET `/api/trips`
**目的**: 全旅行プランの取得

**認証**: Clerk認証必須

**レスポンス**:
```typescript
TripSchema[]
```

##### POST `/api/trips/create`
**目的**: 新規旅行プランの作成

**認証**: Clerk認証必須

**リクエストボディ**:
```typescript
TripSchema
```

**レスポンス**:
```typescript
TripSchema
```

##### GET `/api/trips/{id}`
**目的**: 特定旅行プランの詳細取得

**認証**: Clerk認証必須

**パラメータ**:
- `id`: 旅行プランID（数値）

**レスポンス**:
```typescript
TripSchema
```

##### DELETE `/api/trips/{id}`
**目的**: 旅行プランの削除

**認証**: Clerk認証必須

**パラメータ**:
- `id`: 旅行プランID（数値）

**レスポンス**:
```typescript
{ message: string }
```

#### 画像API

##### POST `/api/trips/upload`
**目的**: 画像のアップロード

**認証**: Clerk認証必須

**レスポンス**:
```typescript
{ url: string }
```

##### GET `/api/trips/{fileName}`
**目的**: 画像の取得

**認証**: 不要

**パラメータ**:
- `fileName`: ファイル名

#### 移動手段API

##### GET `/api/transport`
**目的**: 移動手段マスタの取得

**認証**: Clerk認証必須

**レスポンス**:
```typescript
Array<{
  id: number;
  name: string;
}>
```

#### 出発地・目的地履歴API

##### GET `/api/departure-and-destination`
**目的**: 出発地・目的地履歴の取得

**認証**: Clerk認証必須

**レスポンス**:
```typescript
Array<{
  id: number;
  name: string;
  lat: number;
  lng: number;
}>
```

#### 上限チェックAPI

##### GET `/api/wishlist/count`
**目的**: 行きたいリストの登録数と上限を取得

**認証**: Clerk認証必須

**レスポンス**:
```typescript
{
  count: number;   // 現在の登録数
  limit: number;   // 上限値（100）
}
```

**使用例**:
- 行きたいリスト追加前の上限チェック
- UI上での登録数/上限値の表示

##### GET `/api/trips/count`
**目的**: プランの作成数と上限を取得

**認証**: Clerk認証必須

**レスポンス**:
```typescript
{
  count: number;   // 現在の作成数
  limit: number;   // 上限値（20）
}
```

**使用例**:
- プラン作成前の上限チェック
- UI上での作成数/上限値の表示

**注意事項**:
- プラン作成時は以下の上限も自動チェック:
  - 1日あたりスポット数: 10件
  - プラン日数: 7日
- 上限超過時は400エラーを返却
- エラーメッセージは `LIMIT_ERROR_MESSAGES` から取得

### コントローラー設計

#### TripController (`backend/src/controllers/trip.ts`)

**主要メソッド**:
- `getTrips`: 全旅行プラン取得
- `createTrip`: 旅行プラン作成（上限チェック付き）
- `getTripDetail`: 旅行プラン詳細取得
- `deleteTrip`: 旅行プラン削除
- `getTripCount`: プラン作成数と上限取得

**上限チェックロジック**:
```typescript
// プラン数チェック
const currentTripCount = await prisma.trip.count({ where: { userId } });
if (currentTripCount >= APP_LIMITS.MAX_PLANS) {
  throw new HTTPException(400, { message: LIMIT_ERROR_MESSAGES.PLAN_LIMIT_EXCEEDED });
}

// プラン日数チェック
if (tripData.plans.length > APP_LIMITS.MAX_PLAN_DAYS) {
  throw new HTTPException(400, { message: LIMIT_ERROR_MESSAGES.PLAN_DAYS_LIMIT_EXCEEDED });
}

// 1日あたりスポット数チェック
for (const plan of tripData.plans) {
  if (plan.spots.length > APP_LIMITS.MAX_SPOTS_PER_DAY) {
    throw new HTTPException(400, { message: LIMIT_ERROR_MESSAGES.SPOTS_PER_DAY_LIMIT_EXCEEDED });
  }
}
```

**エラーハンドリング**:
- Prismaエラーの適切な処理
- 認証エラーの処理
- バリデーションエラーの処理
- 上限超過エラーの処理（400ステータス）

#### WishlistController (`backend/src/controllers/wishlist.ts`)

**主要メソッド**:
- `getWishList`: 行きたいリスト取得
- `createWishList`: 行きたいリスト作成（上限チェック付き）
- `updateWishList`: 行きたいリスト更新
- `deleteWishList`: 行きたいリスト削除
- `getWishListCount`: 登録数と上限取得

**上限チェックロジック**:
```typescript
const currentCount = await prisma.wishlist.count({ where: { userId } });
if (currentCount >= APP_LIMITS.MAX_WISHLIST_SPOTS) {
  throw new HTTPException(400, { message: LIMIT_ERROR_MESSAGES.WISHLIST_LIMIT_EXCEEDED });
}
```

#### AuthController (`backend/src/controllers/auth.ts`)

**主要メソッド**:
- `getAuthHandler`: 認証処理とユーザー登録

**処理フロー**:
1. Clerk認証の確認
2. 既存ユーザーのチェック
3. 新規ユーザーの場合はDBに登録
4. 適切なレスポンスを返却

### ミドルウェア設計

#### CORS設定
```typescript
cors({
  origin: 'http://localhost:3000',
  allowMethods: ['GET', 'POST', 'PUT', 'DELETE'],
  allowHeaders: ['Content-Type', 'Authorization', 'X-Clerk-Auth'],
  credentials: true,
  maxAge: 600,
})
```

#### Clerk認証ミドルウェア
- 全APIエンドポイントで認証を必須化
- 認証情報の自動取得
- 認証失敗時の適切なエラーレスポンス

## データベース詳細設計

### テーブル関係図

```
User (1) ----< Trip (1) ----< TripInfo
                    |
                    +----< Plan (1) ----< PlanSpot (N) ----< Spot (1) ----< SpotMeta
                    |                           |
                    +----< Transport (N) ----< TransportMethodOnTransport (N) ----< TransportMethod
                    |                           |
                    +----< NearestStation (N) ----< Spot
```

### 主要テーブル詳細

#### Trip（旅行プラン）
- 基本情報の管理
- ユーザーとの関連付け
- カスケード削除設定

#### Plan（日別プラン）
- 日付ごとのプラン管理
- スポットと移動情報の関連付け

#### Spot（スポット）
- Google Places APIのIDを主キーとして使用
- メタデータは別テーブルで管理

#### Transport（移動情報）
- スポット間の移動情報
- 複数の移動手段をサポート
- 出発地・目的地のタイプ管理

## セキュリティ設計

### 認証・認可
- Clerkを使用したOAuth認証
- JWTトークンベースの認証
- 全APIエンドポイントでの認証必須

### データ保護
- 入力値のバリデーション（Zod）
- SQLインジェクション対策（Prisma ORM）
- XSS対策（Reactの自動エスケープ）

### API セキュリティ
- CORS設定によるオリジン制限
- 適切なHTTPステータスコード
- エラー情報の適切な隠蔽

## パフォーマンス設計

### フロントエンド
- コンポーネントのメモ化
- 状態管理の最適化（Zustand）
- 画像の最適化（Next.js Image）
- コード分割（動的インポート）

### バックエンド
- データベースクエリの最適化
- 適切なインデックス設定
- レスポンスキャッシュ（必要に応じて）

### データベース
- 適切な正規化
- 外部キー制約による整合性保証
- インデックスによる検索性能向上

## エラーハンドリング設計

### フロントエンド
- フォームバリデーション（Zod）
- API エラーの適切な表示
- フォールバック UI の提供
- ローディング状態の管理

### バックエンド
- 統一されたエラーレスポンス形式
- ログ出力によるエラー追跡
- 適切なHTTPステータスコード
- 例外の適切な処理

## テスト設計

### 単体テスト
- コンポーネントのテスト
- ビジネスロジックのテスト
- API エンドポイントのテスト

### 統合テスト
- フロントエンド・バックエンド間の連携テスト
- データベース操作のテスト

### E2Eテスト
- 主要ユーザーフローのテスト
- ブラウザ間の互換性テスト

## デプロイメント設計

### 開発環境
- Docker Composeによる環境構築
- ホットリロード対応
- デバッグツールの統合

### 本番環境
- コンテナベースのデプロイメント
- 環境変数による設定管理
- ログ収集とモニタリング

## 監視・運用設計

### ログ管理
- アプリケーションログの出力
- エラーログの収集
- アクセスログの記録

### パフォーマンス監視
- レスポンス時間の監視
- データベース性能の監視
- リソース使用量の監視

### アラート設定
- エラー率の監視
- レスポンス時間の閾値監視
- リソース使用量の監視
